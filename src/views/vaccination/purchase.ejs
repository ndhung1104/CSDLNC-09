<!DOCTYPE html>
<html lang="vi">

<head><%- include('../partials/common/head') %>
        <link rel="stylesheet" href="/css/management-styles.css">
</head>

<body>
    <div class="app-wrapper">
        <%- include('../partials/management/navbar') %>
            <div class="d-flex flex-grow-1">
                <%- include('../partials/management/sidebar') %>
                    <main class="flex-grow-1 p-4">
                        <h1 class="h3 mb-4">
                            <%= title %>
                        </h1>
                        <% if (error) { %>
                            <div class="alert alert-danger">
                                <%= error %>
                            </div>
                            <% } %>
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">Gói tiêm phòng</div>
                                            <div class="card-body">
                                                <h5>
                                                    <%= plan.name %>
                                                </h5>
                                                <p>Thời gian: <span class="fw-bold">
                                                        <%= plan.duration %> ngày
                                                    </span></p>
                                                <p class="fs-3 fw-bold text-success">
                                                    <%= (plan.price || 0).toLocaleString('vi-VN') %>đ
                                                </p>
                                                <p class="text-muted">
                                                    <%= plan.description %>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">Thông tin mua hàng</div>
                                            <div class="card-body">
                                                <form method="POST" action="/vaccination-plans/<%= plan.id %>/purchase">
                                                    <!-- Pet Autocomplete -->
                                                    <div class="mb-3 position-relative">
                                                        <label class="form-label">Thú cưng <span
                                                                class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" id="petSearch"
                                                            placeholder="Nhập tên thú cưng hoặc chủ sở hữu..."
                                                            autocomplete="off">
                                                        <input type="hidden" name="petId" id="petId"
                                                            value="<%= petId %>" required>
                                                        <div id="petResults"
                                                            class="list-group position-absolute w-100 shadow mt-1"
                                                            style="z-index: 1000; display: none; max-height: 200px; overflow-y: auto;">
                                                        </div>
                                                        <div id="selectedPetInfo" class="form-text text-success"
                                                            style="display: none;"><i
                                                                class="bi bi-check-circle me-1"></i>Đã chọn: <span
                                                                id="petNameDisplay"></span></div>
                                                    </div>

                                                    <div class="d-flex gap-2 mt-4">
                                                        <button type="submit" class="btn btn-success flex-grow-1">
                                                            <i class="bi bi-cart-check me-2"></i>Xác nhận mua
                                                        </button>
                                                        <a href="/vaccination-plans/<%= plan.id %>"
                                                            class="btn btn-outline-secondary">Hủy</a>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                    </main>
            </div>
    </div>
    <%- include('../partials/common/scripts') %>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const searchInput = document.getElementById('petSearch');
                const resultsDiv = document.getElementById('petResults');
                const hiddenInput = document.getElementById('petId');
                const selectedInfo = document.getElementById('selectedPetInfo');
                const nameDisplay = document.getElementById('petNameDisplay');
                let debounceTimer;

                searchInput.addEventListener('input', function () {
                    const query = this.value;
                    if (!query) {
                        resultsDiv.style.display = 'none';
                        return;
                    }

                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        fetch(`/api/pets?q=${encodeURIComponent(query)}`)
                            .then(res => res.json())
                            .then(data => {
                                resultsDiv.innerHTML = '';
                                if (data.length === 0) {
                                    const item = document.createElement('div');
                                    item.className = 'list-group-item text-muted';
                                    item.textContent = 'Không tìm thấy thú cưng';
                                    resultsDiv.appendChild(item);
                                } else {
                                    data.forEach(p => {
                                        const item = document.createElement('a');
                                        item.className = 'list-group-item list-group-item-action';
                                        item.href = '#';
                                        item.innerHTML = `<div><strong>${p.name}</strong> (${p.breedName})</div><small class="text-muted">Chủ: ${p.ownerName}</small>`;
                                        item.addEventListener('click', (e) => {
                                            e.preventDefault();
                                            searchInput.value = p.name;
                                            hiddenInput.value = p.id;
                                            nameDisplay.textContent = `${p.name} - Chủ: ${p.ownerName}`;
                                            selectedInfo.style.display = 'block';
                                            resultsDiv.style.display = 'none';
                                        });
                                        resultsDiv.appendChild(item);
                                    });
                                }
                                resultsDiv.style.display = 'block';
                            });
                    }, 300);
                });

                // Hide results when clicking outside
                document.addEventListener('click', function (e) {
                    if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                        resultsDiv.style.display = 'none';
                    }
                });

                // Allow re-selection if clicking on input
                searchInput.addEventListener('focus', function () {
                    if (this.value) resultsDiv.style.display = 'block';
                });
            });
        </script>
</body>

</html>