<!DOCTYPE html>
<html lang="vi">

<head><%- include('../partials/common/head') %>
        <link rel="stylesheet" href="/css/management-styles.css">
</head>

<body>
    <div class="app-wrapper">
        <%- include('../partials/management/navbar') %>
            <div class="d-flex flex-grow-1">
                <%- include('../partials/management/sidebar') %>
                    <main class="flex-grow-1 p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="h3 mb-0">
                                <%= title %>
                            </h1>
                            <a href="/receipts" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Quay l·∫°i
                            </a>
                        </div>

                        <% if (error) { %>
                            <div class="alert alert-danger alert-dismissible fade show">
                                <%= error %>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                            <% } %>

                                <% if (success) { %>
                                    <div class="alert alert-success alert-dismissible fade show">
                                        <%= success %>
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                    <% } %>

                                        <div class="row g-4">
                                            <!-- Receipt Info -->
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">Th√¥ng tin h√≥a ƒë∆°n</div>
                                                    <div class="card-body">
                                                        <p><strong>M√£ h√≥a ƒë∆°n:</strong> #<%= receipt.RECEIPT_ID %>
                                                        </p>
                                                        <p><strong>Ng√†y t·∫°o:</strong>
                                                            <%= receipt.RECEIPT_CREATED_DATE ? new
                                                                Date(receipt.RECEIPT_CREATED_DATE).toLocaleString('vi-VN')
                                                                : '-' %>
                                                        </p>
                                                        <p><strong>Chi nh√°nh:</strong>
                                                            <%= receipt.branchName || 'N/A' %>
                                                        </p>
                                                        <p><strong>Nh√¢n vi√™n:</strong>
                                                            <%= receipt.employeeName || 'N/A' %>
                                                        </p>
                                                        <p><strong>Kh√°ch h√†ng:</strong>
                                                            <% if (receipt.CUSTOMER_ID) { %>
                                                                <a href="/customers/<%= receipt.CUSTOMER_ID %>">
                                                                    <%= receipt.customerName || 'N/A' %>
                                                                </a>
                                                                <% } else { %>N/A<% } %>
                                                        </p>
                                                        <p><strong>Ph∆∞∆°ng th·ª©c TT:</strong>
                                                            <%= receipt.RECEIPT_PAYMENT_METHOD || 'N/A' %>
                                                        </p>
                                                        <p><strong>Tr·∫°ng th√°i:</strong>
                                                            <span
                                                                class="badge bg-<%= receipt.RECEIPT_STATUS === 'ƒê√£ ho√†n th√†nh' ? 'success' : receipt.RECEIPT_STATUS === 'Ch·ªù thanh to√°n' ? 'warning' : 'secondary' %>">
                                                                <%= receipt.RECEIPT_STATUS %>
                                                            </span>
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Actions -->
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">Thao t√°c</div>
                                                    <div class="card-body">
                                                        <% if (receipt.RECEIPT_STATUS==='Ch·ªù thanh to√°n' ) { %>
                                                            <!-- Add Item Button -->
                                                            <button type="button" class="btn btn-primary w-100 mb-3"
                                                                data-bs-toggle="modal" data-bs-target="#addItemModal">
                                                                <i class="bi bi-plus-circle me-2"></i>Th√™m s·∫£n ph·∫©m/d·ªãch
                                                                v·ª•
                                                            </button>

                                                            <!-- Complete Payment Button -->
                                                            <form method="POST"
                                                                action="/receipts/<%= receipt.RECEIPT_ID %>/complete">
                                                                <button type="submit" class="btn btn-success w-100"
                                                                    <%=receipt.details && receipt.details.length===0
                                                                    ? 'disabled' : '' %>>
                                                                    <i class="bi bi-cash-coin me-2"></i>Thanh to√°n (<%=
                                                                        receipt.RECEIPT_TOTAL_PRICE ?
                                                                        receipt.RECEIPT_TOTAL_PRICE.toLocaleString('vi-VN')
                                                                        + 'ƒë' : '0ƒë' %>)
                                                                </button>
                                                            </form>
                                                            <% if (!receipt.details || receipt.details.length===0) { %>
                                                                <p class="text-muted small mt-2 mb-0">Vui l√≤ng th√™m √≠t
                                                                    nh·∫•t 1 s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n.</p>
                                                                <% } %>
                                                                    <% } else if
                                                                        (receipt.RECEIPT_STATUS==='ƒê√£ ho√†n th√†nh' ) { %>
                                                                        <div class="text-center text-success py-3">
                                                                            <i class="bi bi-check-circle-fill fs-1"></i>
                                                                            <p class="mt-2 mb-0">H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c thanh
                                                                                to√°n</p>
                                                                        </div>
                                                                        <% } else { %>
                                                                            <div class="text-center text-muted py-3">
                                                                                <i class="bi bi-x-circle fs-1"></i>
                                                                                <p class="mt-2 mb-0">H√≥a ƒë∆°n ƒë√£ b·ªã h·ªßy
                                                                                </p>
                                                                            </div>
                                                                            <% } %>
                                                    </div>
                                                    <% if (receipt.RECEIPT_STATUS !=='Ch·ªù thanh to√°n' ) { %>
                                                        <div class="card-footer bg-light">
                                                            <p class="mb-0"><strong>T·ªïng ti·ªÅn:</strong>
                                                                <span class="text-primary fw-bold fs-5">
                                                                    <%= receipt.RECEIPT_TOTAL_PRICE ?
                                                                        receipt.RECEIPT_TOTAL_PRICE.toLocaleString('vi-VN')
                                                                        + 'ƒë' : '0ƒë' %>
                                                                </span>
                                                            </p>
                                                        </div>
                                                        <% } %>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Items Table -->
                                        <div class="card mt-4">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <span>Chi ti·∫øt s·∫£n ph·∫©m/d·ªãch v·ª•</span>
                                                <% if (receipt.RECEIPT_STATUS==='Ch·ªù thanh to√°n' ) { %>
                                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                                        data-bs-toggle="modal" data-bs-target="#addItemModal">
                                                        <i class="bi bi-plus"></i> Th√™m
                                                    </button>
                                                    <% } %>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>S·∫£n ph·∫©m/D·ªãch v·ª•</th>
                                                            <th>S·ªë l∆∞·ª£ng</th>
                                                            <th>ƒê∆°n gi√°</th>
                                                            <th>Th√†nh ti·ªÅn</th>
                                                            <% if (receipt.RECEIPT_STATUS==='Ch·ªù thanh to√°n' ) { %>
                                                                <th></th>
                                                                <% } %>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% if (receipt.details && receipt.details.length> 0) { %>
                                                            <% receipt.details.forEach((item, idx)=> { %>
                                                                <tr>
                                                                    <td>
                                                                        <%= idx + 1 %>
                                                                    </td>
                                                                    <td>
                                                                        <%= item.productName || 'N/A' %>
                                                                    </td>
                                                                    <td>
                                                                        <%= item.RECEIPT_ITEM_AMOUNT || 1 %>
                                                                    </td>
                                                                    <td>
                                                                        <%= item.RECEIPT_ITEM_PRICE ?
                                                                            item.RECEIPT_ITEM_PRICE.toLocaleString('vi-VN')
                                                                            + 'ƒë' : '-' %>
                                                                    </td>
                                                                    <td>
                                                                        <%= (item.RECEIPT_ITEM_AMOUNT *
                                                                            item.RECEIPT_ITEM_PRICE).toLocaleString('vi-VN')
                                                                            %>ƒë
                                                                    </td>
                                                                    <% if (receipt.RECEIPT_STATUS==='Ch·ªù thanh to√°n' ) {
                                                                        %>
                                                                        <td>
                                                                            <form method="POST"
                                                                                action="/receipts/<%= receipt.RECEIPT_ID %>/items/<%= item.RECEIPT_ITEM_ID %>/delete"
                                                                                style="display:inline;">
                                                                                <button type="submit"
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    title="X√≥a"
                                                                                    onclick="return confirm('X√≥a s·∫£n ph·∫©m n√†y?')">
                                                                                    <i class="bi bi-trash"></i>
                                                                                </button>
                                                                            </form>
                                                                        </td>
                                                                        <% } %>
                                                                </tr>
                                                                <% }) %>
                                                                    <% } else { %>
                                                                        <tr>
                                                                            <td colspan="<%= receipt.RECEIPT_STATUS === 'Ch·ªù thanh to√°n' ? 6 : 5 %>"
                                                                                class="text-center text-muted py-3">
                                                                                Ch∆∞a c√≥ chi ti·∫øt
                                                                            </td>
                                                                        </tr>
                                                                        <% } %>
                                                    </tbody>
                                                    <% if (receipt.details && receipt.details.length> 0) { %>
                                                        <tfoot class="table-light">
                                                            <tr>
                                                                <th colspan="4" class="text-end">T·ªïng c·ªông:</th>
                                                                <th colspan="<%= receipt.RECEIPT_STATUS === 'Ch·ªù thanh to√°n' ? 2 : 1 %>"
                                                                    class="text-primary">
                                                                    <%= receipt.RECEIPT_TOTAL_PRICE ?
                                                                        receipt.RECEIPT_TOTAL_PRICE.toLocaleString('vi-VN')
                                                                        + 'ƒë' : '0ƒë' %>
                                                                </th>
                                                            </tr>
                                                        </tfoot>
                                                        <% } %>
                                                </table>
                                            </div>
                                        </div>
                    </main>
            </div>
    </div>

    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Th√™m s·∫£n ph·∫©m/d·ªãch v·ª•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/receipts/<%= receipt.RECEIPT_ID %>/items">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Ch·ªçn s·∫£n ph·∫©m/d·ªãch v·ª• <span class="text-danger">*</span></label>
                            <select name="productId" class="form-select" required>
                                <option value="">-- Ch·ªçn --</option>
                                <% if (typeof products !=='undefined' && products.length> 0) { %>
                                    <optgroup label="üõí S·∫£n ph·∫©m">
                                        <% products.forEach(p=> { %>
                                            <option value="<%= p.id %>" data-item-type="product">
                                                <%= p.name %> - <%= p.price ? p.price.toLocaleString('vi-VN') + 'ƒë'
                                                        : 'N/A' %>
                                            </option>
                                            <% }) %>
                                    </optgroup>
                                    <% } %>
                                        <% if (typeof services !=='undefined' && services.length> 0) { %>
                                            <optgroup label="ü©∫ D·ªãch v·ª• y t·∫ø">
                                                <% services.forEach(s=> { %>
                                                    <option value="<%= s.id %>" data-item-type="service">
                                                        <%= s.name %> - <%= s.price ? s.price.toLocaleString('vi-VN')
                                                                + 'ƒë' : 'N/A' %>
                                                    </option>
                                                    <% }) %>
                                            </optgroup>
                                            <% } %>
                                            <% if (typeof plans !=='undefined' && plans.length> 0) { %>
                                            <optgroup label="Vaccination Plans">
                                                <% plans.forEach(pl=> { %>
                                                    <option value="<%= pl.id %>" data-item-type="plan">
                                                        <%= pl.name %> - <%= pl.price ? pl.price.toLocaleString('vi-VN')
                                                                + 'd' : 'N/A' %>
                                                    </option>
                                                    <% }) %>
                                            </optgroup>
                                            <% } %>
                            </select>
                        </div>
                        <% if (typeof pets !=='undefined' && pets.length> 0) { %>
                        <div class="mb-3">
                            <label class="form-label">Pet (required for plan)</label>
                            <select name="petId" id="petIdSelect" class="form-select">
                                <option value="">-- Select pet --</option>
                                <% pets.forEach(pet=> { %>
                                    <option value="<%= pet.id %>"><%= pet.name %></option>
                                    <% }) %>
                            </select>
                            <div id="planPetNote" class="form-text text-muted" style="display:none;">
                                Pet is required for vaccination plans.
                            </div>
                        </div>
                        <% } else { %>
                        <div class="mb-3">
                            <div class="form-text text-muted">No pets available for this customer.</div>
                        </div>
                        <% } %>
                        <div class="mb-3">
                            <label class="form-label">S? lu?ng</label>
                            <input type="number" name="quantity" class="form-control" value="1" min="1" max="100"
                                required>
                        </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Th√™m
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <%- include('../partials/common/scripts') %>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const itemSelect = document.querySelector('select[name="productId"]');
            const petSelect = document.getElementById('petIdSelect');
            const planNote = document.getElementById('planPetNote');
            if (!itemSelect || !petSelect) return;

            function syncPetRequirement() {
                const selected = itemSelect.options[itemSelect.selectedIndex];
                const itemType = selected ? selected.getAttribute('data-item-type') : null;
                const isPlan = itemType === 'plan';
                petSelect.required = isPlan;
                if (planNote) planNote.style.display = isPlan ? 'block' : 'none';
            }

            itemSelect.addEventListener('change', syncPetRequirement);
            syncPetRequirement();
        });
    </script>

</body>

</html>